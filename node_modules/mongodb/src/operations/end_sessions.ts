import {
  type ClientSession,
  type Connection,
  type ServerCommandOptions,
  type ServerSessionId,
  type TimeoutContext,
  type WriteConcern
} from 'mongodb/src';
import { type Document } from 'mongodb/src/bson';
import { MongoDBResponse } from 'mongodb/src/cmap/wire_protocol/responses';
import { CommandOperation } from 'mongodb/src/operations/command';
import { ReadPreference } from 'mongodb/src/read_preference';
import { MongoDBNamespace } from 'mongodb/src/utils';
import { Aspect, defineAspects } from 'mongodb/src/operations/operation';

export class EndSessionsOperation extends CommandOperation<void> {
  override writeConcern: WriteConcern = { w: 0 };
  override ns = MongoDBNamespace.fromString('admin.$cmd');
  override SERVER_COMMAND_RESPONSE_TYPE = MongoDBResponse;

  private sessions: Array<ServerSessionId>;

  constructor(sessions: Array<ServerSessionId>) {
    super();
    this.sessions = sessions;
  }

  override buildCommandDocument(_connection: Connection, _session?: ClientSession): Document {
    return {
      endSessions: this.sessions
    };
  }
  override buildOptions(timeoutContext: TimeoutContext): ServerCommandOptions {
    return {
      timeoutContext,
      readPreference: ReadPreference.primaryPreferred
    };
  }
  override get commandName(): string {
    return 'endSessions';
  }
}

defineAspects(EndSessionsOperation, Aspect.WRITE_OPERATION);
